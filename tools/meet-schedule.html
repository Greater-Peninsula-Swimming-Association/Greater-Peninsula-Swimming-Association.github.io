<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPSA Meet Schedule Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PapaParse CSV Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://d1nmxxg9d5tdo.cloudfront.net/875/files/apple-touch-icon.png?1651502524">
    <link rel="icon" type="image/png" sizes="32x32" href="https://d1nmxxg9d5tdo.cloudfront.net/875/files/favicon-32x32.png?1651502547">
    <link rel="icon" type="image/png" sizes="16x16" href="https://d1nmxxg9d5tdo.cloudfront.net/875/files/favicon-16x16.png?1651502535">
    <link rel="manifest" href="https://d1nmxxg9d5tdo.cloudfront.net/875/files/site.webmanifest?1651502732">
    <link rel="mask-icon" href="https://d1nmxxg9d5tdo.cloudfront.net/875/files/safari-pinned-tab.svg?1651502580" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <!-- GPSA Common Styles -->
    <link rel="stylesheet" href="../css/gpsa-tools-common.css">
    <!-- GPSA Main Styles (for meet_schedule table preview) -->
    <link rel="stylesheet" href="https://publicity.gpsaswimming.org/css/gpsa-main.css">
</head>
<body>
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="gpsa-header p-4 shadow-md flex items-center justify-center no-print mb-6 rounded-lg">
                <img src="https://publicity.gpsaswimming.org/assets/gpsa_logo.png"
                     alt="GPSA Logo"
                     class="h-16 w-16 md:h-20 md:w-20 mr-4 rounded-full"
                     onerror="this.onerror=null; this.src='https://placehold.co/100x100/002366/FFFFFF?text=GPSA';">
                <div>
                    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold">GPSA Meet Schedule Generator</h1>
                    <p class="gpsa-header-subtitle">Generate meet schedules with links to results</p>
                </div>
            </header>

            <!-- Upload Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">Upload Schedule CSV</h2>
                <div class="flex items-center justify-center w-full">
                    <label for="file-upload" class="file-upload-label flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg bg-gray-50 hover:bg-gray-100">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                            <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span></p>
                            <p id="file-name" class="text-xs text-gray-500">SwimTopia meet schedule CSV file (.csv)</p>
                        </div>
                        <input id="file-upload" type="file" accept=".csv" class="hidden">
                    </label>
                </div>

                <!-- Division Selection -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Division</h3>
                    <div class="flex gap-6 justify-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="division" value="red" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700 font-medium">Red Division</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="division" value="white" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700 font-medium">White Division</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="division" value="blue" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700 font-medium">Blue Division</span>
                        </label>
                    </div>
                    <p id="division-auto-detect" class="text-sm text-gray-500 text-center mt-2 hidden"></p>
                </div>

                <button id="process-button" class="mt-6 w-full btn btn-primary font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all disabled:opacity-50" disabled>
                    Generate Schedule
                </button>
            </div>

            <!-- Preview Section -->
            <div id="preview-section" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Preview</h2>
                    <button id="copy-button" class="btn btn-secondary font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        Copy to Clipboard
                    </button>
                </div>
                <div id="preview-container" class="border-2 border-gray-200 rounded-lg p-4 bg-gray-50">
                    <!-- Generated HTML will be inserted here -->
                </div>
            </div>

            <footer class="text-center mt-10 text-gray-500 text-sm">
                <p>GPSA Meet Schedule Generator v1.1</p>
            </footer>
        </div>
    </main>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <script>
        // Team mapping from build_archive.py
        const TEAM_SCHEDULE_NAME_MAP = {
            "BLMAR": "Beaconsdale",
            "COL": "Colony",
            "CV": "Coventry",
            "EL": "Elizabeth Lake",
            "GWRA": "George Wythe",
            "GG": "Glendale",
            "HW": "Hidenwood",
            "JRCC": "James River",
            "KCD": "Kiln Creek",
            "MBKMT": "Marlbank",
            "NHM": "Northampton",
            "POQ": "Poquoson",
            "RRST": "Riverdale",
            "RMMR": "Running Man",
            "WW": "Wendwood",
            "WO": "Willow Oaks",
            "WPPIR": "Windy Point",
            "WYCC": "Warwick Yacht"
        };

        // DOM Elements
        const fileUploadInput = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const processButton = document.getElementById('process-button');
        const previewSection = document.getElementById('preview-section');
        const previewContainer = document.getElementById('preview-container');
        const copyButton = document.getElementById('copy-button');
        const divisionRadios = document.querySelectorAll('input[name="division"]');
        const divisionAutoDetect = document.getElementById('division-auto-detect');

        let csvData = null;
        let generatedHTML = '';
        let selectedDivision = null;

        // Toast Notification Function
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };

            toast.innerHTML = `
                <span class="toast-icon" aria-hidden="true">${icons[type]}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
                <button class="toast-close" aria-label="Close notification">×</button>
            `;

            container.appendChild(toast);

            const closeBtn = toast.querySelector('.toast-close');
            const removeToast = () => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            };

            closeBtn.addEventListener('click', removeToast);

            if (duration > 0) {
                setTimeout(removeToast, duration);
            }

            return toast;
        }

        // HTML Escape Function
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-detect division from filename
        function detectDivisionFromFilename(filename) {
            const lowerFilename = filename.toLowerCase();
            if (lowerFilename.includes('red')) return 'red';
            if (lowerFilename.includes('white')) return 'white';
            if (lowerFilename.includes('blue')) return 'blue';
            return null;
        }

        // Format date as "MONDAY JUNE 16"
        function formatDateHeader(dateString) {
            // dateString format: "6/16/2025"
            const [month, day, year] = dateString.split('/');
            const date = new Date(year, month - 1, day);

            const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
            const monthName = date.toLocaleDateString('en-US', { month: 'long' }).toUpperCase();
            const dayNumber = parseInt(day, 10);

            return `${dayOfWeek} ${monthName} ${dayNumber}`;
        }

        // Get year from date string
        function getYearFromDate(dateString) {
            const [month, day, year] = dateString.split('/');
            return year;
        }

        // Get team schedule name
        function getTeamScheduleName(abbr) {
            return TEAM_SCHEDULE_NAME_MAP[abbr] || abbr;
        }

        // File upload handler
        fileUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            fileNameDisplay.textContent = file.name;

            // Auto-detect division from filename
            const detectedDivision = detectDivisionFromFilename(file.name);
            if (detectedDivision) {
                document.querySelector(`input[name="division"][value="${detectedDivision}"]`).checked = true;
                selectedDivision = detectedDivision;
                divisionAutoDetect.textContent = `Auto-detected: ${detectedDivision.charAt(0).toUpperCase() + detectedDivision.slice(1)} Division`;
                divisionAutoDetect.classList.remove('hidden');
            }

            // Parse CSV
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    if (results.errors.length > 0) {
                        showToast('Error parsing CSV file. Please check the format.', 'error');
                        processButton.disabled = true;
                        return;
                    }

                    // Validate required columns
                    const requiredColumns = ['MeetDate', 'HomeTeam', 'VisitingTeam'];
                    const firstRow = results.data[0];
                    const missingColumns = requiredColumns.filter(col => !(col in firstRow));

                    if (missingColumns.length > 0) {
                        showToast(`Missing required columns: ${missingColumns.join(', ')}`, 'error', 6000);
                        processButton.disabled = true;
                        return;
                    }

                    csvData = results.data;
                    processButton.disabled = false;
                    showToast('CSV file loaded successfully!', 'success');
                },
                error: (error) => {
                    showToast(`Failed to parse CSV: ${error.message}`, 'error', 6000);
                    processButton.disabled = true;
                }
            });
        });

        // Division radio button handler
        divisionRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                selectedDivision = event.target.value;
            });
        });

        // Process button handler
        processButton.addEventListener('click', () => {
            if (!csvData || !selectedDivision) {
                showToast('Please upload a CSV file and select a division.', 'warning');
                return;
            }

            generateScheduleHTML();
            previewSection.classList.remove('hidden');
            previewSection.scrollIntoView({ behavior: 'smooth' });
        });

        // Generate schedule HTML
        function generateScheduleHTML() {
            const divisionName = selectedDivision.charAt(0).toUpperCase() + selectedDivision.slice(1);

            // Group meets by date
            const meetsByDate = {};
            csvData.forEach(meet => {
                const date = meet.MeetDate;
                if (!meetsByDate[date]) {
                    meetsByDate[date] = [];
                }
                meetsByDate[date].push(meet);
            });

            // Sort dates chronologically
            const sortedDates = Object.keys(meetsByDate).sort((a, b) => {
                const [monthA, dayA, yearA] = a.split('/');
                const [monthB, dayB, yearB] = b.split('/');
                const dateA = new Date(yearA, monthA - 1, dayA);
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateA - dateB;
            });

            // Build HTML
            let html = '<div>\n';
            html += `<h3>\n<a id="${selectedDivision}"></a>${divisionName} Division</h3>\n`;
            html += '<table id="meet_schedule">\n<tbody>\n';

            // Table headers
            html += '<tr>\n';
            html += '\t<th style="width:33%">\n\t\t\t\tDATE\n\t</th>\n';
            html += '\t<th style="width:33%">\n\t\t\t\tHOME\n\t</th>\n';
            html += '\t<th style="width:34%">\n\t\t\t\tVISITOR\n\t</th>\n';
            html += '</tr>\n';

            // Generate rows
            sortedDates.forEach(date => {
                const meets = meetsByDate[date];
                const dateHeader = formatDateHeader(date);
                const rowspan = meets.length;

                meets.forEach((meet, index) => {
                    html += '<tr>\n';

                    // Date cell (only for first row of the date group)
                    if (index === 0) {
                        html += `\t<td rowspan="${rowspan}">\n\t\t\t\t${dateHeader}\n\t</td>\n`;
                    }

                    // Home team
                    const homeTeamName = getTeamScheduleName(meet.HomeTeam);
                    html += `\t<td>\n\t\t\t\t${homeTeamName}\n\t</td>\n`;

                    // Visitor team
                    const visitorTeamName = getTeamScheduleName(meet.VisitingTeam);
                    html += `\t<td>\n\t\t\t\t${visitorTeamName}\n\t</td>\n`;

                    html += '</tr>\n';
                });
            });

            html += '</tbody>\n</table>\n';

            // Add link to results page
            const firstDate = sortedDates[0];
            const year = getYearFromDate(firstDate);
            const resultsPageUrl = `https://publicity.gpsaswimming.org/results/${year}/`;
            html += `<p style="margin-top: 1em;"><a href="${resultsPageUrl}" target="_blank">View Meet Results</a></p>\n`;

            html += '</div>';

            generatedHTML = html;
            previewContainer.innerHTML = html;
        }

        // Copy to clipboard handler
        copyButton.addEventListener('click', async () => {
            if (!generatedHTML) {
                showToast('No schedule to copy. Please generate a schedule first.', 'warning');
                return;
            }

            try {
                await navigator.clipboard.writeText(generatedHTML);
                showToast('Schedule HTML copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to copy to clipboard. Please try again.', 'error');
                console.error('Clipboard error:', err);
            }
        });
    </script>
</body>
</html>
